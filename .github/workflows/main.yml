name: iOS Build (No Codesign, Xcode 15)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-13   # هذا يوفّر Xcode 15.x

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show macOS & Xcode versions
        run: |
          sw_vers
          xcodebuild -version

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"

      - name: Show Flutter version
        run: flutter --version

      # ---------- تثبيت الإصدارات المتوافقة للمكتبات ----------
      - name: Force compatible dependencies
        run: |
          ruby -i -pe "
            gsub(/^\\s*firebase_core:.*/, '  firebase_core: 2.25.4');
            gsub(/^\\s*firebase_auth:.*/, '  firebase_auth: 4.16.0');
            gsub(/^\\s*cloud_firestore:.*/, '  cloud_firestore: 4.15.0');
            gsub(/^\\s*google_mlkit_barcode_scanning:.*/, '  google_mlkit_barcode_scanning: 0.10.0');
            gsub(/^\\s*google_mlkit_commons:.*/, '  google_mlkit_commons: 0.6.1');
          " pubspec.yaml

          echo "===== pubspec.yaml ====="
          cat pubspec.yaml

      - name: Flutter clean & pub get
        run: |
          flutter clean
          rm -f pubspec.lock
          flutter pub get

      # ---------- إصلاح Podfile ----------
      - name: Fix Podfile (iOS 15 + single post_install)
        run: |
          cd ios

          # إزالة أي post_install سابق
          ruby -0777 -i -pe "gsub(/post_install do \\|installer\\|[\\s\\S]*?end/, '')" Podfile

          # إضافة post_install الصحيح
          printf "\npost_install do |installer|\n  installer.pods_project.targets.each do |target|\n    target.build_configurations.each do |config|\n      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'\n    end\n    flutter_additional_ios_build_settings(target)\n  end\nend\n" >> Podfile

          echo "===== Podfile ====="
          cat Podfile
          cd ..

      - name: Install CocoaPods
        run: |
          cd ios
          rm -rf Pods Podfile.lock
          pod repo update
          pod install --repo-update
          cd ..

      # ---------- بناء iOS بدون توقيع ----------
      - name: Build iOS (no codesign)
        run: |
          flutter build ios --release --no-codesign

      # ---------- رفع الناتج ----------
      - name: Upload Runner.app
        uses: actions/upload-artifact@v4
        with:
          name: Runner-app
          path: build/ios/iphoneos/Runner.app
